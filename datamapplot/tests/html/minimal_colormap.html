<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Minimal Colormap Test</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
  rel="stylesheet"
/>
<link rel="preload" href="https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuaabVmUiA8.ttf" as="font" crossorigin="anonymous" type="font/ttf" />
<link rel="preload" href="https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWubEbVmUiA8.ttf" as="font" crossorigin="anonymous" type="font/ttf" />
<link rel="preload" href="https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuYjalmUiA8.ttf" as="font" crossorigin="anonymous" type="font/ttf" />
<link rel="preload" href="https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuZtalmUiA8.ttf" as="font" crossorigin="anonymous" type="font/ttf" />
<style>
b"@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 300;\n  font-stretch: normal;\n  src: url(https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuaabVmUiA8.ttf) format('truetype');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 400;\n  font-stretch: normal;\n  src: url(https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWubEbVmUiA8.ttf) format('truetype');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 700;\n  font-stretch: normal;\n  src: url(https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuYjalmUiA8.ttf) format('truetype');\n}\n@font-face {\n  font-family: 'Roboto';\n  font-style: normal;\n  font-weight: 900;\n  font-stretch: normal;\n  src: url(https://fonts.gstatic.com/s/roboto/v50/KFOMCnqEu92Fr1ME7kSn66aGLdTylUAMQXC89YmC2DPNWuZtalmUiA8.ttf) format('truetype');\n}\n"
</style>

<link
  href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"
  rel="stylesheet"
/>
<link
  href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"
  rel="stylesheet"
/>

<script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
<script src="https://unpkg.com/apache-arrow@latest/Arrow.es2015.min.js"></script>
<script src="https://unpkg.com/d3@latest/dist/d3.min.js"></script>

<style>
  .content-wrapper{top:0;left:0;width:100%;height:100%;z-index:1;padding:0;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;min-height:calc(100vh - 16px);pointer-events:none}.stack{display:flex;flex-direction:column;gap:0;padding:0;pointer-events:none;max-height:50vh;overflow-y:visible}.top-left{grid-column:1;grid-row:1;justify-self:start;align-self:start;align-items:start}.bottom-left{grid-column:1;grid-row:2;justify-self:start;align-self:end;align-items:start;display:flex;flex-direction:column-reverse;transform:scaleY(-1);z-index:2}.top-right{grid-column:2;grid-row:1;justify-self:end;justify-items:end;align-self:start;align-items:end}.bottom-right{grid-column:2;grid-row:2;justify-self:end;justify-items:end;align-self:end;align-items:end;display:flex;flex-direction:column-reverse;transform:scaleY(-1)}.stack.bottom-left .stack-box{transform:scaleY(-1)}.stack.bottom-right .stack-box{transform:scaleY(-1)}#loading{width:100%;height:100%;top:0px;left:0px;position:absolute;display:block;z-index:99}#loading-image{position:absolute;top:45%;left:47.5%;z-index:100}#title-container{top:0;left:0}
</style><style>
  .datamapplot-progress-container{position:absolute;bottom:0;left:50%;transform:translate(-50%,0);width:512px;z-index:101}.datamapplot-progress-bar{width:100%;background-color:#e0e0e044;padding:3px;border-radius:6px;box-shadow:inset 0 1px 3px rgba(128,128,128,.2);margin-bottom:10px}.datamapplot-progress-bar-fill{display:block;height:12px;background-color:#659cef;border-radius:4px;transition:width 500ms ease-in-out}.datamapplot-progress-bar-text{color:white;text-align:center;line-height:12px;font-size:10px;overflow-x:visible;white-space:nowrap;vertical-align:top}
</style><style>
  #colormap-selector-container{position:relative;z-index:100}.color-map-dropdown{background-color:inherit;z-index:100}.color-map-selected{display:flex;align-items:center;padding:10px;border:1px solid #aaaaaa77;border-radius:8px;cursor:pointer;width:100%;box-sizing:border-box;position:relative;z-index:100}.color-map-options{position:fixed;bottom:100%;left:0;right:0;border:1px solid #aaaaaa77;border-radius:4px;box-shadow:0 2px 5px rgba(0,0,0,0.1);max-height:500px;overflow-y:auto;display:none;background-color:inherit;backdrop-filter:blur(6px);box-sizing:border-box;z-index:101}.color-map-option{position:relative;display:flex;align-items:center;padding:10px;cursor:pointer;z-index:102;background-color:inherit;backdrop-filter:blur(6px)}.color-map-option:hover{background-color:#77777744;backdrop-filter:blur(6px)}.color-swatch{display:inline-block;width:fit-content;height:20px;margin-right:10px;border-radius:4px}.color-swatch-box{display:inline-block;width:12px;height:12px;text-align:center;line-height:10px;cursor:pointer}.color-map-text{flex-grow:1}.colorbar-container{display:flex;align-items:center;width:fit-content;gap:4px;padding:10px;height:200px;margin:4px 16px 4px 16px}.color-legend-container{display:flex;align-items:left;width:fit-content;height:fit-content;gap:4px;padding:10px}.colorbar{width:10px;height:200px;position:relative}.colorbar-tick-container{position:relative;width:40px;height:200px}.colorbar-tick{position:absolute;display:flex;align-items:center;gap:4px;transform:translateY(-50%)}.colorbar-tick-line{width:8px;height:1px;background:#333}.colorbar-tick-label{font-size:12px}.legend-item{display:flex;align-items:left;gap:4px;padding:4px}.legend-label{font-size:12px}
</style>
<style>
  body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #ffffff;
    font-family: Roboto;
    color: #000000;
  }
  .container-box {
    margin: 8px 16px 8px 16px;
    padding: 12px;
    border-radius: 16px;
    line-height: 0.95;
    width: fit-content;
    height: fit-content;
    z-index: 2;
    backdrop-filter: blur(3px);
    background: #ffffffaa;
    box-shadow: 2px 3px 10px #aaaaaa44;
    position: relative;
    pointer-events: auto;
  }
  .more-opaque {
    backdrop-filter: blur(6px);
    background-color: #ffffffee;
  }
  #deck-container {
    width: 100vw;
    height: 100vh;  
  }
  #deck-container canvas {
    z-index: 1;
    background: #ffffff;
  }
  .deck-tooltip {
      
            font-size: 0.8em;
            font-family: Roboto;
            font-weight: 300;
            color: #000000 !important;
            background-color: #ffffffee !important;
            border-radius: 12px;
            backdrop-filter: blur(6px);
            box-shadow: 2px 3px 10px #aaaaaa44;
            max-width: 25%;
  }
  input {
    margin: 2px;
    padding: 4px;
    border-radius: 8px;
    color: #000000;
    background: #ffffffdd;
    border: 2px inset #77777744;
    transition: 0.5s;
    outline: none;
    box-sizing: border-box;
  }
  input:focus {
    border: 2px inset #555;
  }
</style>
  </head>
  
  <body>
<div id="loading">
  <img
    id="loading-image"
    src=""
    alt="Loading..."
    width="5%"
  />
</div>
<div style="isolation: isolate; position: relative;">
  <div id="deck-container" style="position: fixed; z-index: -1; top: 0; left: 0; width: 100%; height: 100%;"></div>
  <div class="content-wrapper" style="position: relative; z-index: 1;">
    
    <div class="stack top-left">
      
      <div id="title-container" class="container-box">
        <span
          id="main-title"
          style="font-family:Roboto;font-size:36pt;font-weight:;color:#000000"
        >
          Minimal Colormap Test
        </span>
        <br />
        <span
          style="font-family:Roboto;font-size:18pt;color:#777777"
        >
          For colormap tests
        </span>
      </div>
      

      
      
    </div>
    
    
    <div class="stack top-right">
      
      <div id="legend-container" class="container-box stack-box" style="display:none;">
      </div>
      
    </div>
    
    
    <div class="stack bottom-right">
    </div>
    
    
    <div class="stack bottom-left">
      <div id="colormap-selector-container" class="container-box stack-box"></div></div>
  </div>
  
  
  
</div>



<div id="progress-container" class="datamapplot-progress-container container-box" style="width: 500px; position: absolute;">
  <div id="point-data-progress" class="datamapplot-progress-bar">
    <span class="datamapplot-progress-bar-fill" style="width: 0%;">
      <span class="datamapplot-progress-bar-text">Point Data: 0%</span>
    </span>
  </div>
  <div id="label-data-progress" class="datamapplot-progress-bar">
    <span class="datamapplot-progress-bar-fill" style="width: 0%;">
      <span class="datamapplot-progress-bar-text">Label Data: 0%</span>
    </span>
  </div>
  <div id="meta-data-progress" class="datamapplot-progress-bar">
    <span class="datamapplot-progress-bar-fill" style="width: 0%;">
      <span class="datamapplot-progress-bar-text">Meta Data: 0%</span>
    </span>
  </div>
  <div id="color-data-progress" class="datamapplot-progress-bar">
    <span class="datamapplot-progress-bar-fill" style="width: 0%;">
      <span class="datamapplot-progress-bar-text">Colormap Data: 0%</span>
    </span>
  </div>
</div>
  </body>
  <script>
    LAYER_ORDER=['imageLayer','dataPointLayer','boundaryLayer','labelLayer'];function getLayerIndex(object){return LAYER_ORDER.indexOf(object.id);}
function isFontLoaded(fontName){return document.fonts.check(`12px "${fontName}"`);}
function waitForFont(fontName,maxWait=500){return new Promise((resolve,reject)=>{if(isFontLoaded(fontName)){resolve();}else{const startTime=Date.now();const interval=setInterval(()=>{if(isFontLoaded(fontName)){clearInterval(interval);resolve();}else if(Date.now()-startTime>maxWait){clearInterval(interval);reject(new Error(`Font ${fontName} did not load within ${maxWait}ms`));}},50);}});}
function getInitialViewportSize(){const width=document.documentElement.clientWidth;const height=document.documentElement.clientHeight;return{viewportWidth:width,viewportHeight:height};}
function calculateZoomLevel(bounds,viewportWidth,viewportHeight,padding=0.5){const lngRange=bounds[1]-bounds[0];const latRange=bounds[3]-bounds[2];const centerLng=(bounds[0]+bounds[1])/2;const centerLat=(bounds[2]+bounds[3])/2;const zoomX=Math.log2(360/(lngRange/(viewportWidth/256)));const zoomY=Math.log2(180/(latRange/(viewportHeight/256)));const zoom=Math.min(zoomX,zoomY)-padding;return{zoomLevel:zoom,dataCenter:[centerLng,centerLat]};}
class DataMap{constructor({container,bounds,searchItemId="text-search",lassoSelectionItemId="lasso-selection",}){this.container=container;this.searchItemId=searchItemId;this.lassoSelectionItemId=lassoSelectionItemId;this.pointData=null;this.labelData=null;this.metaData=null;this.layers=[];const{viewportWidth,viewportHeight}=getInitialViewportSize();const{zoomLevel,dataCenter}=calculateZoomLevel(bounds,viewportWidth,viewportHeight);this.deckgl=new deck.DeckGL({container:container,initialViewState:{latitude:dataCenter[1],longitude:dataCenter[0],zoom:zoomLevel},controller:{scrollZoom:{speed:0.01,smooth:true}},});this.updateTriggerCounter=0;this.dataSelectionManager=new DataSelectionManager(lassoSelectionItemId);}
addPoints(pointData,{pointSize,pointOutlineColor=[250,250,250,128],pointLineWidth=0.001,pointHoverColor=[170,0,0,187],pointLineWidthMaxPixels=3,pointLineWidthMinPixels=0.001,pointRadiusMaxPixels=16,pointRadiusMinPixels=0.2,}){const numPoints=pointData.x.length;const positions=new Float32Array(numPoints*2);const colors=new Uint8Array(numPoints*4);const variableSize=pointSize<0;let sizes;if(variableSize){sizes=new Float32Array(numPoints);}else{sizes=null;}
for(let i=0;i<numPoints;i++){positions[i*2]=pointData.x[i];positions[i*2+1]=pointData.y[i];colors[i*4]=pointData.r[i];colors[i*4+1]=pointData.g[i];colors[i*4+2]=pointData.b[i];colors[i*4+3]=pointData.a[i];if(variableSize){sizes[i]=pointData.size[i];}}
this.originalColors=colors;this.selected=new Float32Array(numPoints).fill(1.0);this.pointSize=pointSize;this.pointOutlineColor=pointOutlineColor;this.pointLineWidth=pointLineWidth;this.pointHoverColor=pointHoverColor;this.pointLineWidthMaxPixels=pointLineWidthMaxPixels;this.pointLineWidthMinPixels=pointLineWidthMinPixels;this.pointRadiusMaxPixels=pointRadiusMaxPixels;this.pointRadiusMinPixels=pointRadiusMinPixels;let scatterAttributes={getPosition:{value:positions,size:2},getFillColor:{value:colors,size:4},getFilterValue:{value:this.selected,size:1}};if(variableSize){scatterAttributes.getRadius={value:sizes,size:1};}
this.pointLayer=new deck.ScatterplotLayer({id:'dataPointLayer',data:{length:numPoints,attributes:scatterAttributes},getRadius:this.pointSize,getLineColor:this.pointOutlineColor,getLineWidth:this.pointLineWidth,highlightColor:this.pointHoverColor,lineWidthMaxPixels:this.pointLineWidthMaxPixels,lineWidthMinPixels:this.pointLineWidthMinPixels,radiusMaxPixels:this.pointRadiusMaxPixels,radiusMinPixels:this.pointRadiusMinPixels,radiusUnits:"common",lineWidthUnits:"common",autoHighlight:true,pickable:true,stroked:true,extensions:[new deck.DataFilterExtension({filterSize:1})],filterRange:[-0.5,1.5],filterSoftRange:[0.75,1.25],updateTriggers:{getFilterValue:this.updateTriggerCounter},instanceCount:numPoints,parameters:{depthTest:false}});this.layers.push(this.pointLayer);this.layers.sort((a,b)=>getLayerIndex(a)-getLayerIndex(b));this.deckgl.setProps({layers:[...this.layers]});}
addEdges(edgeData,{edgeWidth=0.05,edgeOpacity=0.8,}){const numEdges=edgeData.r.length;this.edgeWidth=edgeWidth;this.edgeOpacity=edgeOpacity;const sourcePosition=new Float32Array(numEdges*2);const targetPosition=new Float32Array(numEdges*2);const colors=new Uint8Array(numEdges*4);let lineAttributes={getSourcePosition:{value:sourcePosition,size:2},getTargetPosition:{value:targetPosition,size:2},getColor:{value:colors,size:4},};for(let i=0;i<numEdges;i++){sourcePosition[i*2]=edgeData.x1[i];sourcePosition[i*2+1]=edgeData.y1[i];targetPosition[i*2]=edgeData.x2[i];targetPosition[i*2+1]=edgeData.y2[i];colors[i*4]=edgeData.r[i];colors[i*4+1]=edgeData.g[i];colors[i*4+2]=edgeData.b[i];colors[i*4+3]=180;}
this.edgeLayer=new deck.LineLayer({id:'edgeLayer',data:{length:numEdges,attributes:lineAttributes},getSourcePosition:d=>[d.source.x,d.source.y],getTargetPosition:d=>[d.target.x,d.target.y],getWidth:this.edgeWidth,});this.layers.push(this.edgeLayer);this.layers.sort((a,b)=>getLayerIndex(a)-getLayerIndex(b));this.deckgl.setProps({layers:[...this.layers]});}
addLabels(labelData,{labelTextColor=d=>[d.r,d.g,d.b],textMinPixelSize=18,textMaxPixelSize=36,textOutlineWidth=8,textOutlineColor=[238,238,238,221],textBackgroundColor=[255,255,255,64],fontFamily="Roboto",fontWeight=900,lineSpacing=0.95,textCollisionSizeScale=3.0,noiseLabel="Unlabelled",pickable=false,}){const numLabels=labelData.length;this.labelTextColor=labelTextColor;this.textMinPixelSize=textMinPixelSize;this.textMaxPixelSize=textMaxPixelSize;this.textOutlineWidth=textOutlineWidth;this.textOutlineColor=textOutlineColor;this.textBackgroundColor=textBackgroundColor;this.fontFamily=fontFamily;this.fontWeight=fontWeight;this.lineSpacing=lineSpacing;this.textCollisionSizeScale=textCollisionSizeScale;waitForFont(this.fontFamily);this.labelLayer=new deck.TextLayer({id:'labelLayer',data:labelData.filter(d=>d.label!==noiseLabel),pickable:pickable,getPosition:d=>[d.x,d.y],getText:d=>d.label,getColor:this.labelTextColor,getSize:d=>d.size,sizeScale:1,sizeMinPixels:this.textMinPixelSize,sizeMaxPixels:this.textMaxPixelSize,outlineWidth:this.textOutlineWidth,outlineColor:this.textOutlineColor,getBackgroundColor:this.textBackgroundColor,getBackgroundPadding:[15,15,15,15],background:true,characterSet:"auto",fontFamily:this.fontFamily,fontWeight:this.fontWeight,lineHeight:this.lineSpacing,fontSettings:{"sdf":true},getTextAnchor:"middle",getAlignmentBaseline:"center",lineHeight:0.95,elevation:100,collisionEnabled:true,getCollisionPriority:d=>d.size,collisionTestProps:{sizeScale:this.textCollisionSizeScale,sizeMaxPixels:this.textMaxPixelSize*2,sizeMinPixels:this.textMinPixelSize*2},extensions:[new deck.CollisionFilterExtension()],instanceCount:numLabels,parameters:{depthTest:false}});this.layers.push(this.labelLayer);this.layers.sort((a,b)=>getLayerIndex(a)-getLayerIndex(b));this.deckgl.setProps({layers:[...this.layers]});}
addBoundaries(boundaryData,{clusterBoundaryLineWidth=0.5}){const numBoundaries=boundaryData.length;this.clusterBoundaryLineWidth=clusterBoundaryLineWidth;this.boundaryLayer=new deck.PolygonLayer({id:'boundaryLayer',data:boundaryData,stroked:true,filled:false,getLineColor:d=>[d.r,d.g,d.b,d.a],getPolygon:d=>d.polygon,lineWidthUnits:"common",getLineWidth:d=>d.size*d.size,lineWidthScale:this.clusterBoundaryLineWidth*5e-5,lineJointRounded:true,lineWidthMaxPixels:4,lineWidthMinPixels:0.0,instanceCount:numBoundaries,parameters:{depthTest:false}});this.layers.push(this.boundaryLayer);this.layers.sort((a,b)=>getLayerIndex(a)-getLayerIndex(b));this.deckgl.setProps({layers:[...this.layers]});}
addMetaData(metaData,{tooltipFunction=({index})=>this.metaData.hover_text[index],onClickFunction=null,searchField=null,}){this.metaData=metaData;this.tooltipFunction=tooltipFunction;this.onClickFunction=onClickFunction;this.searchField=searchField;if(this.metaData.hasOwnProperty('hover_text')){this.deckgl.setProps({getTooltip:this.tooltipFunction,});}
if(this.onClickFunction){this.deckgl.setProps({onClick:this.onClickFunction,});}
if(this.searchField){this.searchArray=this.metaData[this.searchField].map(d=>d.toLowerCase());}}
connectHistogram(histogramItem){this.histogramItem=histogramItem;this.histogramItemId=histogramItem.state.chart.chartContainerId;}
addBackgroundImage(image,bounds){this.imageLayer=new deck.BitmapLayer({id:'imageLayer',bounds:bounds,image:image,parameters:{depthTest:false}});this.layers.push(this.imageLayer);this.layers.sort((a,b)=>getLayerIndex(a)-getLayerIndex(b));this.deckgl.setProps({layers:[...this.layers]});}
async addSelectionHandler(callback,selectionKind="lasso-selection",timeoutMs=60000){const startTime=Date.now();if(selectionKind==="lasso-selection"){while(!this.lassoSelector){if(Date.now()-startTime>timeoutMs){throw new Error('Timeout: lassoSelector did not become available within the specified timeout period');}
await new Promise(resolve=>setTimeout(resolve,1000));}
this.lassoSelector.registerSelectionHandler(callback);}else{if(!this.selectionCallbacks){this.selectionCallbacks={};}
if(this.selectionCallbacks[selectionKind]){this.selectionCallbacks[selectionKind].push(callback);}
this.selectionCallbacks[selectionKind]=[callback];}}
highlightPoints(itemId){const selectedIndices=this.dataSelectionManager.getSelectedIndices();const semiSelectedIndices=this.dataSelectionManager.getBasicSelectedIndices();const hasSelectedIndices=selectedIndices.size!==0;const hasSemiSelectedIndices=semiSelectedIndices.size!==0;const hasLassoSelection=this.dataSelectionManager.hasSpecialSelection();if(hasLassoSelection){if(hasSelectedIndices){if(hasSemiSelectedIndices){this.selected.fill(-1.0);for(let i of semiSelectedIndices){this.selected[i]=0.0;}}else{this.selected.fill(0.0);}
for(let i of selectedIndices){this.selected[i]=1.0;}}else{this.selected.fill(1.0);}}else{if(hasSelectedIndices){this.selected.fill(-1.0);for(let i of selectedIndices){this.selected[i]=1.0;}}else{this.selected.fill(1.0);}}
this.updateTriggerCounter++;const sizeAdjust=1/(1+(Math.sqrt(selectedIndices.size)/Math.log2(this.selected.length)));const updatedPointLayer=this.pointLayer.clone({data:{...this.pointLayer.props.data,attributes:{...this.pointLayer.props.data.attributes,getFilterValue:{value:this.selected,size:1}}},radiusMinPixels:hasSelectedIndices?2*(this.pointRadiusMinPixels+sizeAdjust):this.pointRadiusMinPixels,updateTriggers:{getFilterValue:this.updateTriggerCounter,radiusMinPixels:this.updateTriggerCounter,}});const idx=this.layers.indexOf(this.pointLayer);this.layers=[...this.layers.slice(0,idx),updatedPointLayer,...this.layers.slice(idx+1)];this.deckgl.setProps({layers:this.layers});this.pointLayer=updatedPointLayer;if(this.histogramItem&&itemId!==this.histogramItemId){if(hasSelectedIndices){this.histogramItem.drawChartWithSelection(selectedIndices);}else{this.histogramItem.removeChartWithSelection(selectedIndices);}}}
addSelection(selectedIndices,selectionKind){this.dataSelectionManager.addOrUpdateSelectedIndicesOfItem(selectedIndices,selectionKind);this.highlightPoints(selectionKind);if(this.selectionCallbacks&&this.selectionCallbacks[selectionKind]){const currentSelectedIndices=Array.from(this.dataSelectionManager.getSelectedIndices());for(let callback of this.selectionCallbacks[selectionKind]){callback(currentSelectedIndices);}}}
removeSelection(selectionKind){this.dataSelectionManager.removeSelectedIndicesOfItem(selectionKind);this.highlightPoints(selectionKind);if(this.selectionCallbacks&&this.selectionCallbacks[selectionKind]){const currentSelectedIndices=Array.from(this.dataSelectionManager.getSelectedIndices());for(let callback of this.selectionCallbacks[selectionKind]){callback(currentSelectedIndices);}}}
getSelectedIndices(){return this.dataSelectionManager.getSelectedIndices();}
searchText(searchTerm){const searchTermLower=searchTerm.toLowerCase();const selectedIndices=this.searchArray.reduce((indices,d,i)=>{if(d.indexOf(searchTermLower)>=0){indices.push(i);}
return indices;},[]);if(searchTerm===""){this.dataSelectionManager.removeSelectedIndicesOfItem(this.searchItemId);}else{this.dataSelectionManager.addOrUpdateSelectedIndicesOfItem(selectedIndices,this.searchItemId);}
if(this.selectionCallbacks&&this.selectionCallbacks[this.searchItemId]){const currentSelectedIndices=Array.from(this.dataSelectionManager.getSelectedIndices());for(let callback of this.selectionCallbacks[this.searchItemId]){callback(currentSelectedIndices);}}
this.highlightPoints(this.searchItemId);}
recolorPoints(colorData,fieldName){if(!this.hasOwnProperty(`${fieldName}Colors`)){const numPoints=colorData[`${fieldName}_r`].length;const colors=new Uint8Array(numPoints*4);for(let i=0;i<numPoints;i++){colors[i*4]=colorData[`${fieldName}_r`][i];colors[i*4+1]=colorData[`${fieldName}_g`][i];colors[i*4+2]=colorData[`${fieldName}_b`][i];colors[i*4+3]=colorData[`${fieldName}_a`][i];}
this[`${fieldName}Colors`]=colors;}
const updatedPointLayer=this.pointLayer.clone({data:{...this.pointLayer.props.data,attributes:{...this.pointLayer.props.data.attributes,getFillColor:{value:this[`${fieldName}Colors`],size:4}}},transitions:{getFillColor:{duration:1500,easing:d3.easeCubicInOut}}});this.updateTriggerCounter++;const idx=this.layers.indexOf(this.pointLayer);this.layers=[...this.layers.slice(0,idx),updatedPointLayer,...this.layers.slice(idx+1)];this.deckgl.setProps({layers:this.layers});this.pointLayer=updatedPointLayer;}
resetPointColors(){const updatedPointLayer=this.pointLayer.clone({data:{...this.pointLayer.props.data,attributes:{...this.pointLayer.props.data.attributes,getFillColor:{value:this.originalColors,size:4}}},transitions:{getFillColor:{duration:1500,easing:d3.easeCubicInOut}}});this.updateTriggerCounter++;const idx=this.layers.indexOf(this.pointLayer);this.layers=[...this.layers.slice(0,idx),updatedPointLayer,...this.layers.slice(idx+1)];this.deckgl.setProps({layers:this.layers});this.pointLayer=updatedPointLayer;}}
  </script>
  <script>
    class DataSelectionManager{constructor(specialItem){this.excludeItem=specialItem;this.selectedIndicesByItem={};this.selectedIndicesCommon=new Set();this.selectedIndicesBasicCommon=new Set();}
addOrUpdateSelectedIndicesOfItem(indices,itemId){const isNewItem=!this.selectedIndicesByItem.hasOwnProperty(itemId);this.selectedIndicesByItem[itemId]=new Set(indices);this.#updateSelectedIndicesCommon(isNewItem?itemId:null);}
removeSelectedIndicesOfItem(itemId){if(this.selectedIndicesByItem.hasOwnProperty(itemId)){delete this.selectedIndicesByItem[itemId];this.#updateSelectedIndicesCommon();}}
getSelectedIndices(){return this.selectedIndicesCommon;}
getBasicSelectedIndices(){return this.selectedIndicesBasicCommon;}
hasSpecialSelection(){return this.selectedIndicesByItem.hasOwnProperty(this.excludeItem);}#updateSelectedIndicesCommon(newItem=null){const sets=Object.values(this.selectedIndicesByItem);if(sets.length===0){this.selectedIndicesCommon=new Set();this.selectedIndicesBasicCommon=new Set();return;}
if(sets.length===1){this.selectedIndicesCommon=sets[0];if(Object.keys(this.selectedIndicesByItem)[0]!==this.excludeItem){this.selectedIndicesBasicCommon=sets[0];}else{this.selectedIndicesBasicCommon=new Set();}
return;}
if(newItem){const newSet=this.selectedIndicesByItem[newItem];this.selectedIndicesCommon=this.selectedIndicesCommon.intersection(newSet);if(newItem!==this.excludeItem){this.selectedIndicesBasicCommon=this.selectedIndicesBasicCommon.intersection(newSet);}
return;}
this.selectedIndicesCommon=sets[0];for(let i=1;i<sets.length;i++){this.selectedIndicesCommon=this.selectedIndicesCommon.intersection(sets[i]);if(this.selectedIndicesCommon.size===0){break;}}
const otherSelectionItems=Object.keys(this.selectedIndicesByItem).filter(key=>key!==this.excludeItem);this.selectedIndicesBasicCommon=this.selectedIndicesByItem[otherSelectionItems[0]];for(let i=1;i<otherSelectionItems.length;i++){const otherSelection=this.selectedIndicesByItem[otherSelectionItems[i]];this.selectedIndicesBasicCommon=this.selectedIndicesBasicCommon.intersection(otherSelection);}}}
  </script>
  <script>
    class Colorbar{constructor(container,options={}){this.container=container;this.options={width:options.width||40,height:options.height||300,min:options.min||0,max:options.max||100,numTicks:options.numTicks||5,colormap:options.colormap||['blue','red'],label:options.label||'',dateFormat:options.dateFormat||'short'};this.isDateScale=this.options.min instanceof Date||typeof this.options.min==='string'&&!isNaN(Date.parse(this.options.min));if(this.isDateScale){this.options.min=this.ensureDate(this.options.min);this.options.max=this.ensureDate(this.options.max);this.analyzeDateTimeRange();}else{this.analyzeNumericRange();}
this.render();}
analyzeDateTimeRange(){const{min,max}=this.options;const rangeMs=max.getTime()-min.getTime();const rangeHours=rangeMs/(1000*60*60);const rangeDays=rangeHours/24;const rangeMonths=rangeDays/30.44;const rangeYears=rangeMonths/12;if(rangeYears>=2){this.dateTimeFormat={year:'numeric',month:'short'};}else if(rangeMonths>=2){this.dateTimeFormat={month:'short',day:'numeric'};}else if(rangeDays>=2){this.dateTimeFormat={month:'short',day:'numeric',hour:'2-digit'};}else if(rangeHours>=2){this.dateTimeFormat={hour:'2-digit',minute:'2-digit'};}else{this.dateTimeFormat={hour:'2-digit',minute:'2-digit',second:'2-digit'};}}
analyzeNumericRange(){const{min,max}=this.options;this.isIntegerData=Number.isInteger(min)&&Number.isInteger(max);const maxAbs=Math.max(Math.abs(min),Math.abs(max));const minAbs=Math.min(Math.abs(min),Math.abs(max));this.useScientific=maxAbs>=1e5||(minAbs>0&&minAbs<=1e-4);if(!this.isIntegerData&&!this.useScientific){const range=max-min;if(range<1){this.decimals=3;}else if(range<10){this.decimals=2;}else{this.decimals=1;}}}
ensureDate(value){if(value instanceof Date)return value;return new Date(value);}
formatNumber(value){if(this.isIntegerData){return Math.round(value).toString();}
if(this.useScientific){return value.toExponential(2);}
if(Number.isInteger(value)){return value.toString();}
return value.toFixed(this.decimals);}
formatValue(value){if(this.isDateScale){const date=value instanceof Date?value:new Date(value);if(this.options.dateFormat){return date.toLocaleDateString(undefined,this.options.dateFormat);}else{return date.toLocaleString(undefined,this.dateTimeFormat);}}
return this.formatNumber(value);}
createColorScale(){const{colormap}=this.options;if(colormap.length===0)return'none';if(colormap.length===1)return colormap[0];return`linear-gradient(to top, ${colormap.join(', ')})`;}
generateTicks(){const{min,max,numTicks}=this.options;const ticks=[];for(let i=numTicks-1;i>=0;i--){let value;if(this.isDateScale){const minTime=min.getTime();const maxTime=max.getTime();const timeRange=maxTime-minTime;value=new Date(minTime+(i/(numTicks-1))*timeRange);}else{value=min+(i/(numTicks-1))*(max-min);}
const position=100-(i/(numTicks-1)*100);ticks.push({value:value,formattedValue:this.formatValue(value),position});}
return ticks;}
render(){const wrapper=document.createElement('div');wrapper.className='colorbar-container';const colorbar=document.createElement('div');colorbar.className='colorbar';colorbar.style.background=this.createColorScale();const tickContainer=document.createElement('div');tickContainer.className='colorbar-tick-container';const ticks=this.generateTicks();ticks.forEach(tick=>{const tickElement=document.createElement('div');tickElement.className='colorbar-tick';tickElement.style.top=`${tick.position}%`;const tickLine=document.createElement('div');tickLine.className='colorbar-tick-line';const tickLabel=document.createElement('div');tickLabel.className='colorbar-tick-label';tickLabel.textContent=tick.formattedValue;tickElement.appendChild(tickLine);tickElement.appendChild(tickLabel);tickContainer.appendChild(tickElement);});if(this.options.label){const label=document.createElement('div');label.style.writingMode='vertical-rl';label.style.transform='rotate(180deg)';label.style.marginRight='8px';label.textContent=this.options.label;wrapper.appendChild(label);}
wrapper.appendChild(colorbar);wrapper.appendChild(tickContainer);this.container.appendChild(wrapper);}}
function convertRGBtoObj(colorString){const rgbKeys=['r','g','b','a'];let rgbObj={};let color=colorString.replace(/^rgba?\(|\s+|\)$/g,'').split(',');for(let i in rgbKeys)
rgbObj[rgbKeys[i]]=parseInt(color[i])||1;return rgbObj;}
class ColorLegend{constructor(container,datamap,colorData,colorField,options={}){this.container=container;this.options={width:options.width||400,colormap:options.colormap||{"High":"blue","Low":"red"},label:options.label||''};this.datamap=datamap;this.colorData=colorData;this.colorField=colorField;this.selectedItems=new Set();this.legendItems=[];this.render();}
render(){for(const[label,color]of Object.entries(this.options.colormap)){const legendItem=document.createElement('div');legendItem.className='legend-item';const colorBox=document.createElement('div');colorBox.className='color-swatch-box';colorBox.style.borderRadius="2px";colorBox.style.backgroundColor=color;const labelElement=document.createElement('div');labelElement.className='legend-label';labelElement.textContent=label;legendItem.appendChild(colorBox);legendItem.appendChild(labelElement);this.container.appendChild(legendItem);this.legendItems.push(legendItem);}
this.container.addEventListener('click',(event)=>{const selection=event.srcElement.style.backgroundColor;if(selection){if(this.selectedItems.has(selection)){this.selectedItems.delete(selection);}else{this.selectedItems.add(selection);}
const selectedIndices=[];this.selectedItems.forEach((color)=>{const selectedColor=convertRGBtoObj(color);for(let i=0;i<this.colorData[`${this.colorField}_r`].length;i++){;if(Math.abs(this.colorData[`${this.colorField}_r`][i]-selectedColor.r)<=1&&Math.abs(this.colorData[`${this.colorField}_g`][i]-selectedColor.g)<=1&&Math.abs(this.colorData[`${this.colorField}_b`][i]-selectedColor.b)<=1){selectedIndices.push(i);}}});if(this.selectedItems.size>0){this.datamap.addSelection(selectedIndices,"legend");this.legendItems.forEach((item)=>{if(this.selectedItems.has(item.children[0].style.backgroundColor)){item.style.opacity=1;}else{item.style.opacity=0.25;}});}else{this.datamap.removeSelection("legend");this.legendItems.forEach((item)=>{item.style.opacity=1;});}}});}}
class ColormapSelectorTool{constructor(colorMaps,colorMapContainer,colorData,legendContainer,datamap,nColors=5){this.colorMaps=colorMaps;this.colorMapContainer=colorMapContainer;this.colorData=colorData;this.datamap=datamap;this.nColors=nColors;this.legendContainer=legendContainer;for(const colorMap of this.colorMaps){if(Object.hasOwn(colorMap,"nColors")){this.nColors=Math.max(this.nColors,colorMap.nColors);}}
this.selectedColorMap=colorMaps[0];this.measureDiv=document.createElement("div");this.measureDiv.style.position="absolute";this.measureDiv.style.visibility="hidden";this.measureDiv.style.whiteSpace="nowrap";document.body.appendChild(this.measureDiv);const maxWidth=this.calculateMaxWidth();this.colorMapDropdown=document.createElement("div");this.colorMapDropdown.className="color-map-dropdown";this.colorMapDropdown.style.width=`${maxWidth}px`;const colorMapSelected=document.createElement("div");colorMapSelected.className="color-map-selected";this.selectedColorSwatch=document.createElement("span");this.selectedColorSwatch.className="color-swatch";this.selectedColorSwatch.id="selectedColorSwatch";colorMapSelected.appendChild(this.selectedColorSwatch);this.selectedColorMapText=document.createElement("span");this.selectedColorMapText.className="color-map-text";this.selectedColorMapText.id="selectedColorMapText";colorMapSelected.appendChild(this.selectedColorMapText);const downArrow=document.createElement("span");downArrow.className="dropdown-arrow";downArrow.innerHTML="â–¼";colorMapSelected.appendChild(downArrow);this.colorMapDropdown.appendChild(colorMapSelected);this.colorMapOptions=document.createElement("div");this.colorMapOptions.className="color-map-options";this.colorMapOptions.id="colorMapOptions";this.colorMapOptions.style.display='none';this.colorMapOptions.style.width=`${maxWidth}px`;this.colorMapDropdown.appendChild(this.colorMapOptions);this.colorMapContainer.appendChild(this.colorMapDropdown);this.colorMapContainer.style.width=`${maxWidth + 20}px`;this.colorMapDropdown.addEventListener('click',(e)=>{this.colorMapOptions.style.display=this.colorMapOptions.style.display==='none'?'block':'none'});this.updateSelectedColorMap();this.populateColorMapOptions();this.populateLegends();document.body.removeChild(this.measureDiv);}
calculateMaxWidth(){let maxWidth=0;this.measureDiv.className="color-map-option";for(const colorMap of this.colorMaps){this.measureDiv.innerHTML=`${this.createColorSwatch(colorMap.colors)} <span class="color-map-text">${colorMap.description}</span>`;const width=this.measureDiv.offsetWidth+40;maxWidth=Math.max(maxWidth,width);}
return maxWidth;}
createColorSwatch(colors,categorical=false){const n=Math.min(this.nColors,colors.length);var result='<span class="color-swatch">'
if(colors.length>16&&!categorical){const stepSize=(colors.length-1)/(n-1);for(let i=0;i<colors.length;i+=stepSize){result+=`<span class="color-swatch-box"; style="background: ${colors[Math.round(i)]}"></span>`}}else{for(let i=0;i<n;i++){result+=`<span class="color-swatch-box"; style="background: ${colors[Math.round(i)]}"></span>`}}
result+='</span>'
return result;}
handleColorMapSelection(colorMap){this.selectedColorMap=colorMap;this.updateSelectedColorMap();if(colorMap.field==='none'){this.datamap.resetPointColors();this.legendContainer.style.display='none';}else{this.datamap.recolorPoints(this.colorData,colorMap.field);if(((colorMap.kind==="categorical")&&((colorMap.colors.length<=20)||colorMap.showLegend)&&Object.hasOwn(colorMap,"colorMapping"))||(colorMap.kind==="continuous")||(colorMap.kind==="datetime")){this.legendContainer.style.display='block';for(const key in this.legends){this.legends[key].style.display='none';}
this.legends[colorMap.field].style.display='block';}else{this.legendContainer.style.display='none';}}}
updateSelectedColorMap(){this.selectedColorSwatch.innerHTML=(this.createColorSwatch(this.selectedColorMap.colors,this.selectedColorMap.kind==="categorical"));this.selectedColorMapText.innerHTML=this.selectedColorMap.description;}
populateColorMapOptions(){for(const colorMap of this.colorMaps){const colorMapOption=document.createElement("div");colorMapOption.className="color-map-option";colorMapOption.addEventListener('click',(event)=>{this.handleColorMapSelection(colorMap)});colorMapOption.innerHTML=`${this.createColorSwatch(colorMap.colors, colorMap.kind === "categorical")} <span class="color-map-text">${colorMap.description}</span>`;this.colorMapOptions.appendChild(colorMapOption);}}
populateLegends(){this.legends={};for(const colorMap of this.colorMaps){if(colorMap.field==='none'){continue;}
this.legends[colorMap.field]=document.createElement("div");this.legends[colorMap.field].className="color-legend-container";this.legends[colorMap.field].style.display='none';if((colorMap.kind==="categorical")&&((colorMap.colors.length<=20)||colorMap.showLegend)&&Object.hasOwn(colorMap,"colorMapping")){new ColorLegend(this.legends[colorMap.field],this.datamap,this.colorData,colorMap.field,{colormap:colorMap.colorMapping});}else if(colorMap.kind==="continuous"){new Colorbar(this.legends[colorMap.field],{colormap:colorMap.colors,label:colorMap.description,min:colorMap.valueRange[0],max:colorMap.valueRange[1]});}else if(colorMap.kind==="datetime"){new Colorbar(this.legends[colorMap.field],{colormap:colorMap.colors,label:colorMap.description,min:new Date(colorMap.valueRange[0]),max:new Date(colorMap.valueRange[1]),dateFormat:colorMap.dateFormat});}
this.legendContainer.appendChild(this.legends[colorMap.field]);}}}
  </script><script type="module">
    // =========================================================================
    // Utility Functions
    // =========================================================================
    
    
function debounce(func, timeout = 250) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

async function simpleArrowParser(arrow_bytes) {
  const table = await Arrow.tableFromIPC(arrow_bytes);
  const result = {};
  table.schema.fields.forEach((field) => {
    result[field.name] = table.getChild(field.name).toArray();
  });
  return result;
}

function mergeTypedArrays(arrays) {
  let totalLength = arrays.reduce((acc, arr) => acc + arr.length, 0);
  let result = new arrays[0].constructor(totalLength);
  let currentLength = 0;
  for (let arr of arrays) {
    result.set(arr, currentLength);
    currentLength += arr.length;
  }
  return result;
}



function updateProgressBar(id, progress) {
  const progressBar = document.querySelector(`#${id} .datamapplot-progress-bar-fill`);
  const progressText = document.querySelector(`#${id} .datamapplot-progress-bar-text`);
  if (progressBar && progressText) {
    progressBar.style.width = `${progress}%`;
    progressText.textContent = `${id.replace('-progress', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}: ${progress}%`;
  }
}

function checkAllDataLoaded() {
  const progressBars = document.querySelectorAll('.datamapplot-progress-bar-fill');
  const allLoaded = Array.from(progressBars).every(bar => bar.style.width === '100%');
  if (allLoaded) {
    const loadingEl = document.getElementById("loading");
    const progressEl = document.getElementById("progress-container");
    if (loadingEl) loadingEl.style.display = "none";
    if (progressEl) progressEl.style.display = "none";
  }
}
    
    


    // =========================================================================
    // Browser Compatibility Check
    // =========================================================================
    
    if (!("CompressionStream" in window)) {
      throw new Error(
        "Your browser doesn't support the Compression Streams API " +
        "https://developer.mozilla.org/docs/Web/API/Compression_Streams_API#browser_compatibility"
      );
    }

    // =========================================================================
    // Data Setup
    // =========================================================================
    
    




const pointDataEncoded = "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";
const hoverDataEncoded = "H4sIAIQAYGkC/61aTY/bNhD9K4RPLZACHH6ztyABigDrTRGnvRRFodrcXaG25Ehy2rTof69sBuhBY4Cc0W0P+zQc8nE4857/2bz0n9Pw25T+mjbfi182u6mZ2nFq981RbNP00h9G0XbibTM1YrdvU7dP4hslFXwrvhO75nQ+JnHu224ScvNKbD4OTTc+pUE8pGbo2u5ZvD6fh77Zv6TxhlMLHFxxb/rT+TLNuJ/bse27K+o4r2Ga/844s8CpK+6H1KVh/rfPSWz7QzqO4qkfxLtT8/w1nlzg9BVXmuYSbohp2ivusZkuwxzyoemeL/MaxU/dIQ3j1HSH60d2X8Ypne4t3F2/8P48taf279vOiI9p/9K1ny4pp719uBPbX5FvUzqLx3SL/5imP/vhjwx7c2zGsX36ut13TjeUBYe4QMaS84Ww5IUsOmC9BN4Y9XqaUndb6HZeaNO14+l2xI8PP94LWMao5d7AjVIfUtvN/7pPpznu/8SYQ37of+9nqt2FmxpGInhbkC/CJ3BFNw8B+poFIzc+lCx4eeMh8nmsZElsBAeVsZGboFQJMRGcLrpCCNBUFh0kb8sjp3JF9RIp777iUi2LgMocE7vpcvgi+iexnYO1Xbq7AmTpK9BNy9pvLFPRUFj4ESi1pGlNfmy04d8UbVf4hqskP7J9voi8CDDwbo2OJVVqGddQmzBTW96QG2sUsUwZTavJxpTgkGRtXW1AegXjKg4YwxcxCwMGYj01sbyeInFtGbOWzYIFXlwqqWxNn4/hDY2U1vKYYcseTCRwbZePBa+qW0uS2UisP06yWmgHxELtFIudrqbzR7I2vOiWeDec4x2z87wZ2hEHABdL2hkkYV9Dr2VcD7w77VVlK4KM8JrdzXhDVFq85c173vHTZzLOB9Y04SO/Hw2S1q2E0vYfEW0UmzRBF00QS9IEQ7vjgd+cBUcTRIKnPfkhEOPFGlIvzyZSe7IItPEiKqKWFyveSUxCNMSmN9pC2RJZcmXRwj7hK6mMZB7YCk6MvEYYpGR1KSCBrAAr4pQEUrO3HqTh6z8gCxmIyZ3SkTeuknmYyCtDbfqI0isjWcSXTFUcgNcyAChieQWoZB92+NkVIClwAJVmE8Z+cGTVEcCz33CAwMg/8gyZbBKwzDrIhgHBnwSlmKvXzJujDNVAs8R3GrJNwBMvQHnqugNf/QQVqQeuuaVOF3ENy1wrdn8BeoW3NpsGFRUTqTq6SA7B6oVmqrmgPdGC1TVzKYaP7AkPykwDLG0DRK0SslfAsufAaPJgDMaw9AAwVM/dOJoKAMbznUQwga9jQHYSCvYdSd8S7XfINgKPMFbxi4wt8uLR6NQhFrKlQB/AsqXA3DueHQ91zgL2gUjvR6vcBQwP1Ekg+wvMIcpp/vm52gcWW4flNabZdqDz2PkV9iEU3V+MBMyhwhP1X/BA/WWlX6HgeU10DcAb5oZZ/nF7R179ChKKDytMNT4SFXjIjgPpR5sQgFcyQ5l0h0XWdMUsmBUGuexAEFxGyMYDZQ4L1N+DANV8gBDp+xwllZORLItEtcJlykYEpZZmD4KUsiX2vCtYEBCpP2GDGFieOcS4+fXf/wC/G3jtYDAAAA==";
const labelDataEncoded = "H4sIAIQAYGkC/3XRPU/DMBAG4L8SeU4t2+ezz1lhLBViYKEMbmWiiNZBTiK+xH/HpIYiRfX0LtZz997DJzv4XTiwhl31x5dpDKm674auj6xmb6xZSU5WO7JOoKvZO2sEJwRFVpHQNRu6j8AaBVzULLFGnlKbk5zTLietfpJnjdFcfNVn8dqPvrrpYhfbk+a4AiOtFmj0jCkulXYgwAEtMLDFsrpQ9pK08eOU/KFa+9hOvg3beJv6fRiGP3oFHLRBlKjJzLbhSIBgwDi1XFSogmssuDGX8DDbmzC+9ul5KJ7jYMEomR/O3io3hsaCRWnVUiRdQFIFBLgA3oUuPvVpH44hjtu4Dj6dO0YOSI4MCmdnN3/OfedBFC07JiyqE7/nlO4/+/gNDps7y0ICAAA=";


const colorDataEncoded = "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";




const parsingWorkerBlob = new Blob([`
  self.onmessage = async function(event) {
  const { encodedData, JSONParse } = event.data;
    // Function to parse base64 to Uint8Array
    async function DecompressBytes(bytes) {
      const blob = new Blob([bytes]);
      const decompressedStream = blob.stream().pipeThrough(
        new DecompressionStream("gzip")
      );
      const arr = await new Response(decompressedStream).arrayBuffer()
      return new Uint8Array(arr);
    }
    async function decodeBase64WithProgress(base64) {
      const totalLength = base64.length;
      const chunkSize = 1024 * 1024; // 1MB chunks
      let decodedArray = new Uint8Array(Math.ceil(totalLength * 3 / 4));
      let offset = 0;

      for (let i = 0; i < totalLength; i += chunkSize) {
        const chunk = base64.slice(i, i + chunkSize);
        const decodedChunk = Uint8Array.from(atob(chunk), c => c.charCodeAt(0));
        decodedArray.set(decodedChunk, offset);
        offset += decodedChunk.length;

        const progress = Math.min(100, Math.round((i + chunkSize) / totalLength * 100));
        self.postMessage({ type: 'progress', progress: progress });

        // Allow other operations to occur
        await new Promise(resolve => setTimeout(resolve, 0));
      }

      return decodedArray.slice(0, offset);
    }
    const decodedData = await decodeBase64WithProgress(encodedData);
    const decompressedData = await DecompressBytes(decodedData);
    if (JSONParse) {
      const parsedData = JSON.parse(new TextDecoder("utf-8").decode(decompressedData));
      self.postMessage({ type: "data", data: parsedData });
    } else {
      self.postMessage({ type: "data", data: decompressedData });
    }
  }
`], { type: 'application/javascript' });



const workerUrl = URL.createObjectURL(parsingWorkerBlob);

    // =========================================================================
    // DataMap Initialization
    // =========================================================================
    
    
const searchItemId = "text-search";
const histogramItemId = "d3histogram-container";
const selectionItemId = "lasso-select";
let histogramItem = null;

const container = document.getElementById('deck-container');

const datamap = new DataMap({
  container: container,
  bounds: [-16.843317522518475, 13.156682477481521, -16.57203942711521, 12.527657967099305],
  searchItemId: searchItemId,
  lassoSelectionItemId: selectionItemId,      
});

    // =========================================================================
    // Data Loading Functions
    // =========================================================================
    
    








// =============================================================================
// Point Data Loading
// =============================================================================

function loadPointDataLayer() {
  const pointDataWorker = new Worker(workerUrl);
  pointDataWorker.postMessage({encodedData: pointDataEncoded, JSONParse: false});

  pointDataWorker.onmessage = async function(event) {
    if (event.data.type === "progress") {
      updateProgressBar('point-data-progress', event.data.progress);
    } else {
      const { data } = event.data;
      

  const parsedData = await simpleArrowParser(data);


      const pointData = parsedData;
      
      datamap.addPoints(pointData, {
        pointSize: 0.11818567912070806,
        pointOutlineColor: [250, 250, 250, 128],
        pointLineWidth: 0.001,
        pointHoverColor: [170, 0, 0, 187],
        pointLineWidthMaxPixels: 3,
        pointLineWidthMinPixels: 0.001,
        pointRadiusMaxPixels: 24,
        pointRadiusMinPixels: 0.01,
      });

      document.getElementById("loading").style.display = "none";
      updateProgressBar('point-data-progress', 100);
      checkAllDataLoaded();
      
      
    }
  };

  
  loadColorData();
  
  
  
}


// =============================================================================
// Color Data Loading
// =============================================================================

function loadColorData() {
  const colorDataWorker = new Worker(workerUrl);
  colorDataWorker.postMessage({encodedData: colorDataEncoded, JSONParse: false});

  colorDataWorker.onmessage = async function(event) {
    if (event.data.type === "progress") {
      updateProgressBar('color-data-progress', event.data.progress);
    } else {
      const { data } = event.data;
      

  const parsedData = await simpleArrowParser(data);


      const colorData = parsedData;

      document.getElementById("loading").style.display = "none";
      updateProgressBar('color-data-progress', 100);
      checkAllDataLoaded();

      const colorMapContainer = document.getElementById("colormap-selector-container");
      const legendContainer = document.getElementById("legend-container");
      
      const colorMaps = [{"field": "none", "description": "Clusters", "colors": ["#93a0eb", "#9a9514", "#c83e78", "#008c88", "#d8cbef"], "kind": "categorical"}, {"field": "Value", "description": "Value", "colors": ["#440154", "#440256", "#450457", "#450559", "#46075a", "#46085c", "#460a5d", "#460b5e", "#470d60", "#470e61", "#471063", "#471164", "#471365", "#481467", "#481668", "#481769", "#48186a", "#481a6c", "#481b6d", "#481c6e", "#481d6f", "#481f70", "#482071", "#482173", "#482374", "#482475", "#482576", "#482677", "#482878", "#482979", "#472a7a", "#472c7a", "#472d7b", "#472e7c", "#472f7d", "#46307e", "#46327e", "#46337f", "#463480", "#453581", "#453781", "#453882", "#443983", "#443a83", "#443b84", "#433d84", "#433e85", "#423f85", "#424086", "#424186", "#414287", "#414487", "#404588", "#404688", "#3f4788", "#3f4889", "#3e4989", "#3e4a89", "#3e4c8a", "#3d4d8a", "#3d4e8a", "#3c4f8a", "#3c508b", "#3b518b", "#3b528b", "#3a538b", "#3a548c", "#39558c", "#39568c", "#38588c", "#38598c", "#375a8c", "#375b8d", "#365c8d", "#365d8d", "#355e8d", "#355f8d", "#34608d", "#34618d", "#33628d", "#33638d", "#32648e", "#32658e", "#31668e", "#31678e", "#31688e", "#30698e", "#306a8e", "#2f6b8e", "#2f6c8e", "#2e6d8e", "#2e6e8e", "#2e6f8e", "#2d708e", "#2d718e", "#2c718e", "#2c728e", "#2c738e", "#2b748e", "#2b758e", "#2a768e", "#2a778e", "#2a788e", "#29798e", "#297a8e", "#297b8e", "#287c8e", "#287d8e", "#277e8e", "#277f8e", "#27808e", "#26818e", "#26828e", "#26828e", "#25838e", "#25848e", "#25858e", "#24868e", "#24878e", "#23888e", "#23898e", "#238a8d", "#228b8d", "#228c8d", "#228d8d", "#218e8d", "#218f8d", "#21908d", "#21918c", "#20928c", "#20928c", "#20938c", "#1f948c", "#1f958b", "#1f968b", "#1f978b", "#1f988b", "#1f998a", "#1f9a8a", "#1e9b8a", "#1e9c89", "#1e9d89", "#1f9e89", "#1f9f88", "#1fa088", "#1fa188", "#1fa187", "#1fa287", "#20a386", "#20a486", "#21a585", "#21a685", "#22a785", "#22a884", "#23a983", "#24aa83", "#25ab82", "#25ac82", "#26ad81", "#27ad81", "#28ae80", "#29af7f", "#2ab07f", "#2cb17e", "#2db27d", "#2eb37c", "#2fb47c", "#31b57b", "#32b67a", "#34b679", "#35b779", "#37b878", "#38b977", "#3aba76", "#3bbb75", "#3dbc74", "#3fbc73", "#40bd72", "#42be71", "#44bf70", "#46c06f", "#48c16e", "#4ac16d", "#4cc26c", "#4ec36b", "#50c46a", "#52c569", "#54c568", "#56c667", "#58c765", "#5ac864", "#5cc863", "#5ec962", "#60ca60", "#63cb5f", "#65cb5e", "#67cc5c", "#69cd5b", "#6ccd5a", "#6ece58", "#70cf57", "#73d056", "#75d054", "#77d153", "#7ad151", "#7cd250", "#7fd34e", "#81d34d", "#84d44b", "#86d549", "#89d548", "#8bd646", "#8ed645", "#90d743", "#93d741", "#95d840", "#98d83e", "#9bd93c", "#9dd93b", "#a0da39", "#a2da37", "#a5db36", "#a8db34", "#aadc32", "#addc30", "#b0dd2f", "#b2dd2d", "#b5de2b", "#b8de29", "#bade28", "#bddf26", "#c0df25", "#c2df23", "#c5e021", "#c8e020", "#cae11f", "#cde11d", "#d0e11c", "#d2e21b", "#d5e21a", "#d8e219", "#dae319", "#dde318", "#dfe318", "#e2e418", "#e5e419", "#e7e419", "#eae51a", "#ece51b", "#efe51c", "#f1e51d", "#f4e61e", "#f6e620", "#f8e621", "#fbe723", "#fde725"], "kind": "continuous", "nColors": 5, "valueRange": [0.005522117123602399, 0.9868869366005173]}, {"field": "Category", "description": "Category", "colors": ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"], "kind": "categorical", "nColors": 5, "colorMapping": {"A": "#1f77b4", "B": "#8c564b", "C": "#17becf"}}];
      const colorSelector = new ColormapSelectorTool(
        colorMaps,
        colorMapContainer,
        colorData,
        legendContainer,
        datamap,
      );
      datamap.colorSelector = colorSelector;
    }
  };
}




// =============================================================================
// Label Data Loading
// =============================================================================

function loadLabelDataLayer() {
  const labelDataWorker = new Worker(workerUrl);
  labelDataWorker.postMessage({encodedData: labelDataEncoded, JSONParse: true});

  labelDataWorker.onmessage = async function(event) {
    if (event.data.type === "progress") {
      updateProgressBar('label-data-progress', event.data.progress);
    } else {
      const { data } = event.data;
      

  const parsedData = data;


      const labelData = parsedData;
      
      datamap.labelData = labelData;
      
      datamap.addLabels(
        
        labelData
        ,
        {
          labelTextColor: d => [d.r, d.g, d.b],
          textMinPixelSize: 18,
          textMaxPixelSize: 36,
          textOutlineWidth: 8,
          textOutlineColor: [238, 238, 238, 221],
          textBackgroundColor: [255, 255, 255, 64],
          fontFamily: "Roboto",
          fontWeight: 600,
          lineSpacing: 0.95,
          textCollisionSizeScale: 3,
          noiseLabel: "Unlabelled",
          pickable: false,
        }
      );

      
      
      
      
      document.getElementById("loading").style.display = "none";
      updateProgressBar('label-data-progress', 100);
      checkAllDataLoaded();
    }
  };
}



// =============================================================================
// Meta Data Loading
// =============================================================================

function loadMetaData() {
  const metaDataWorker = new Worker(workerUrl);
  metaDataWorker.postMessage({encodedData: hoverDataEncoded, JSONParse: true});

  metaDataWorker.onmessage = async function(event) {
    if (event.data.type === "progress") {
      updateProgressBar('meta-data-progress', event.data.progress);
    } else {
      const { data } = event.data;
      

  const parsedData = data;


      const hoverData = parsedData;
      
      datamap.addMetaData(hoverData, {
        tooltipFunction: ({index}) => hoverData.hover_text[index],
        onClickFunction: null,
        searchField: "hover_text",
      });

      
      
      updateProgressBar('meta-data-progress', 100);
      checkAllDataLoaded();
    }
  };
}



    // =========================================================================
    // Initialization
    // =========================================================================

    loadPointDataLayer();
    loadLabelDataLayer();
    loadMetaData();
  </script>
</html>